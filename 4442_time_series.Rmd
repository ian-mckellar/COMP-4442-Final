---
title: "COMP-4442 Final Project"
author: "Zack Larson, Ian McKellar, Suvechhya Pokhrel"
date: "3/2/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(tidyverse)
library(stringr)
library(plotly)
library(forecast)

```

## R Markdown

Data Parsing / Cleanup

```{r}

election_raw <- read.csv('countypres_2000-2020.csv', header = TRUE, sep = ",") #election data

election_raw$state <- as.factor(election_raw$state)
election_raw$county_name <- as.factor(election_raw$county_name)
election_raw$candidate <- as.factor(election_raw$candidate)
election_raw$party <- as.factor(election_raw$party)

election_2020_counties_won <- election_raw %>%
  filter(year == 2020) %>%
  group_by(county_name) %>%
  filter(candidatevotes == max(candidatevotes, na.rm = TRUE)) %>%
  ungroup() # County level results

election_2020 <- election_raw %>% filter(year == 2020) # County level total votes

election_2020_counties_won <- droplevels(election_2020_counties_won) # Remove unused factors
election_2020 <- droplevels(election_2020)

election_2020_state <- election_raw %>% filter(year == 2020)
election_2020_state <- aggregate(candidatevotes ~ state + candidate, data = election_2020_state, FUN = sum)
election_2020_state <- election_2020_state %>%
  group_by(state) %>%
  filter(candidatevotes == max(candidatevotes, na.rm = TRUE)) %>%
  ungroup() # Results per state

election_2020_state <- droplevels(election_2020_state)


# Loading the covid vaccine data

tscounty <- read.csv("counties.timeseries.csv", sep = ",")
#str(tscounty)

#filtering and cleaning data according to our need

tscounty.final <- dplyr::select(tscounty, date, country, state, fips, county, actuals.cases, actuals.vaccinationsCompleted)
#str(tscounty.final)


tscounty.final %>% replace_na(list(actuals.cases = 0, actuals.vaccinationsCompleted = 0))


#merging state and county columns to know which county and state will be included as our sample
tscounty.final$combined <- str_c(tscounty.final$county, ",", tscounty.final$state)

#We can also categorize them into democrat and republic and then take 5 samples from each group
sample.county <- sample(tscounty.final$combined, 12)
#sample.county

```
```{r}
count_vaccine <- merge(x=election_2020, y=tscounty.final, by.x = "county_fips", by.y = "fips", all = TRUE)
#count_vaccine
```
Plots & exploratory data analysis

```{r}

# Sample data and plots for CO

colorado_data <- subset(election_2020, state == 'COLORADO')
colorado_data_counties_won <- subset(election_2020_counties_won, state == 'COLORADO')

candidate_votes_co <- ggplot(data = colorado_data, aes(x = candidate, y = candidatevotes)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ggtitle('Votes per Candidate in CO')

county_candidate_co <- ggplot(data = colorado_data_counties_won, aes(candidate)) +
  geom_bar() +
  ggtitle('CO Counties per Candidate')


figure <- ggarrange(candidate_votes_co, county_candidate_co,
                    labels = c("1", "2"),
                    ncol = 2, nrow = 1)
#figure

# Add % of voter turnout per county plot?


#Visualizing the vaccination rates in selected counties
tscounty.final %>%
  filter(combined %in% sample.county) %>%
  ggplot(aes(x = date, y = actuals.vaccinationsCompleted, group = combined, color = combined)) +
  geom_line(size = 1.25) +
  facet_wrap(~combined, scales = 'free_y', ncol = 3) +
  theme(legend.position = 'none') +
  labs(color = '', x = 'Month', y = 'Cumulative Vaccinations By County') +
  scale_color_brewer(type = 'qual', palette = 'Paired')

# Creating an interactive plot using plotly
p <- ggplot2::last_plot() +
  geom_line(size = 0.75) + # modifying the plot for plotly
  theme_bw(base_size = 9) +
  theme(legend.position = 'none') # to make margins smaller
ggplotly(p, height = 900)

#fig <- plotly_build(p)
#fig

```

Time Series Analysis

```{r}
count_vaccine_col <- subset(count_vaccine, state.x == 'COLORADO')
count_vaccine_col$date <- as.character.Date(count_vaccine_col$date)
count_vaccine_col <- na.omit(count_vaccine_col)
min_date <- min(count_vaccine_col$date)
max_date <- max(count_vaccine_col$date)
#count_vaccine_col_mat <- matrix(count_vaccine_col)
first_ts <- ts(count_vaccine_col$actuals.cases)#, start=min_date, end=max_date, frequency = 365.25)
#first_ts
```
```{r}
plot.ts(first_ts)
```
getting the census data

```{r}
plot(count_vaccine_col$actuals.cases)
```

```{r}
census_education <- read.csv('education/data.csv', header = TRUE, sep = ",", skip = 1)
names(census_education)
```
```{r}
census_income <- read.csv('income/data.csv', header = TRUE, sep = ",", skip = 1)
names(census_income)
```

```{r}
census_race <- read.csv('race/data.csv', header = TRUE, sep = ",", skip = 1)
names(census_race)
```
